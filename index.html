<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MusicMap – Global Top Tracks (Apple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0e0e11;
      color: #ffffff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.7;
      margin-bottom: 16px;
    }

    .controls {
      margin-bottom: 16px;
    }

    select {
      padding: 10px;
      font-size: 16px;
      background: #1e1e26;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      min-width: 220px;
      margin-right: 10px;
    }

    .label {
      font-size: 14px;
      margin-right: 6px;
      opacity: 0.8;
    }

    .meta {
      margin-top: 8px;
      opacity: 0.75;
      font-size: 14px;
    }

    .tables-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .table-card {
      background: #14141c;
      border-radius: 10px;
      padding: 10px 10px 16px 10px;
      border: 1px solid #262636;
    }

    .table-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .table-subtitle {
      font-size: 13px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
    }

    th, td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #2a2a33;
      vertical-align: middle;
      font-size: 13px;
    }

    th {
      opacity: 0.6;
      font-weight: normal;
    }

    .rank {
      width: 32px;
      opacity: 0.7;
    }

    .cover-cell {
      width: 46px;
    }

    .cover-img {
      width: 38px;
      height: 38px;
      border-radius: 4px;
      object-fit: cover;
    }

    .track-title a {
      color: #f5f5f5;
      text-decoration: none;
    }

    .track-title a:hover {
      text-decoration: underline;
    }

    .artist {
      opacity: 0.85;
      font-size: 12px;
    }

    .status-col {
      width: 90px;
    }

    .status-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
    }

    .row-both {
      background: #10231a;
    }

    .row-unique-left {
      background: #241416;
    }

    .row-unique-right {
      background: #1b1424;
    }

    .tag-both {
      background: #245b3f;
      color: #bfffd7;
    }

    .tag-unique {
      background: #5b2424;
      color: #ffd7d7;
    }

    .legend {
      margin-top: 16px;
      font-size: 12px;
      opacity: 0.8;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 16px;
      height: 10px;
      border-radius: 3px;
    }

    .footer {
      margin-top: 24px;
      opacity: 0.4;
      font-size: 12px;
    }
  </style>
</head>

<body>

  <h1>MusicMap</h1>
  <div class="subtitle">Live Apple Music Top Tracks per land</div>

  <div class="controls">
    <div style="margin-bottom: 8px;">
      <span class="label">Hoofdland:</span>
      <select id="countrySelectPrimary"></select>
    </div>
    <div>
      <span class="label">Vergelijk met:</span>
      <select id="countrySelectSecondary"></select>
    </div>
    <div class="meta">
      Vergelijk: <span id="compareLabel">NL vs DE</span> · Datum: <span id="dateLabel">–</span>
    </div>
  </div>

  <div class="tables-wrapper">
    <!-- Linker tabel: hoofdland -->
    <div class="table-card">
      <div class="table-title" id="titleLeft">Top 20 – NL</div>
      <div class="table-subtitle" id="subtitleLeft">Hoofdland</div>
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th></th>
            <th>Track</th>
            <th>Artist</th>
            <th class="status-col">Status</th>
          </tr>
        </thead>
        <tbody id="tracksBodyLeft">
          <tr>
            <td colspan="5">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Rechter tabel: vergelijkland -->
    <div class="table-card">
      <div class="table-title" id="titleRight">Top 20 – DE</div>
      <div class="table-subtitle" id="subtitleRight">Vergelijkland</div>
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th></th>
            <th>Track</th>
            <th>Artist</th>
            <th class="status-col">Status</th>
          </tr>
        </thead>
        <tbody id="tracksBodyRight">
          <tr>
            <td colspan="5">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="legend">
    <div class="legend-item">
      <div class="legend-swatch" style="background:#10231a;"></div>
      <span>Groen: track staat in <strong>beide</strong> landen</span>
    </div>
    <div class="legend-item">
      <div class="legend-swatch" style="background:#241416;"></div>
      <span>Rood links: track staat <strong>alleen in hoofdland</strong></span>
    </div>
    <div class="legend-item">
      <div class="legend-swatch" style="background:#1b1424;"></div>
      <span>Rood rechts: track staat <strong>alleen in vergelijkland</strong></span>
    </div>
  </div>

  <div class="footer">
    Data source: Apple Music top songs RSS · Demo v1
  </div>

<script>
  // Beschikbare landen voor Apple Music RSS
  const countries = [
    { code: "NL", label: "Netherlands" },
    { code: "BE", label: "Belgium" },
    { code: "DE", label: "Germany" },
    { code: "FR", label: "France" },
    { code: "GB", label: "United Kingdom" },
    { code: "US", label: "United States" },
    { code: "ES", label: "Spain" },
    { code: "IT", label: "Italy" },
    { code: "SE", label: "Sweden" },
    { code: "NO", label: "Norway" },
    { code: "DK", label: "Denmark" },
    { code: "FI", label: "Finland" },
    { code: "IE", label: "Ireland" },
    { code: "PT", label: "Portugal" },
    { code: "BR", label: "Brazil" },
    { code: "MX", label: "Mexico" },
    { code: "CA", label: "Canada" },
    { code: "AU", label: "Australia" },
    { code: "JP", label: "Japan" },
    { code: "KR", label: "South Korea" }
  ];

  const primarySelect = document.getElementById("countrySelectPrimary");
  const secondarySelect = document.getElementById("countrySelectSecondary");
  const compareLabel = document.getElementById("compareLabel");
  const dateLabel = document.getElementById("dateLabel");
  const tracksBodyLeft = document.getElementById("tracksBodyLeft");
  const tracksBodyRight = document.getElementById("tracksBodyRight");
  const titleLeft = document.getElementById("titleLeft");
  const titleRight = document.getElementById("titleRight");
  const subtitleLeft = document.getElementById("subtitleLeft");
  const subtitleRight = document.getElementById("subtitleRight");

  function populateCountrySelects() {
    countries.forEach(c => {
      const opt1 = document.createElement("option");
      opt1.value = c.code;
      opt1.textContent = c.label;
      if (c.code === "NL") opt1.selected = true;
      primarySelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = c.code;
      opt2.textContent = c.label;
      if (c.code === "DE") opt2.selected = true;
      secondarySelect.appendChild(opt2);
    });
  }

  async function fetchTopTracks(countryCode, limit = 20) {
    const res = await fetch(
      `/api/top-country-apple?country_code=${encodeURIComponent(countryCode)}&limit=${encodeURIComponent(limit)}`
    );
    if (!res.ok) {
      throw new Error(`API error: ${res.status}`);
    }
    return await res.json();
  }

  function buildKey(track) {
    return (track.title || "").toLowerCase().trim() + "___" +
           (track.artist || "").toLowerCase().trim();
  }

  function renderTable(bodyEl, tracks, otherMap, countryCode, side) {
    bodyEl.innerHTML = "";

    if (!tracks || tracks.length === 0) {
      bodyEl.innerHTML = "<tr><td colspan='5'>Geen tracks gevonden.</td></tr>";
      return;
    }

    tracks.forEach(track => {
      const key = buildKey(track);
      const inBoth = otherMap.has(key);
      const tr = document.createElement("tr");

      if (inBoth) {
        tr.className = "row-both";
      } else if (side === "left") {
        tr.className = "row-unique-left";
      } else {
        tr.className = "row-unique-right";
      }

      const rankTd = document.createElement("td");
      rankTd.className = "rank";
      rankTd.textContent = track.rank;

      const coverTd = document.createElement("td");
      coverTd.className = "cover-cell";
      if (track.cover) {
        const img = document.createElement("img");
        img.src = track.cover;
        img.alt = track.title || "Cover";
        img.className = "cover-img";
        coverTd.appendChild(img);
      }

      const titleTd = document.createElement("td");
      titleTd.className = "track-title";
      if (track.link) {
        const a = document.createElement("a");
        a.href = track.link;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = track.title;
        titleTd.appendChild(a);
      } else {
        titleTd.textContent = track.title;
      }

      const artistTd = document.createElement("td");
      artistTd.className = "artist";
      artistTd.textContent = track.artist;

      const statusTd = document.createElement("td");
      statusTd.className = "status-col";
      const statusSpan = document.createElement("span");
      statusSpan.className = "status-tag";

      if (inBoth) {
        statusSpan.classList.add("tag-both");
        statusSpan.textContent = "Beide landen";
      } else {
        statusSpan.classList.add("tag-unique");
        statusSpan.textContent = `Alleen in ${countryCode}`;
      }

      statusTd.appendChild(statusSpan);

      tr.appendChild(rankTd);
      tr.appendChild(coverTd);
      tr.appendChild(titleTd);
      tr.appendChild(artistTd);
      tr.appendChild(statusTd);

      bodyEl.appendChild(tr);
    });
  }

  async function loadCompare() {
    const countryA = primarySelect.value;
    const countryB = secondarySelect.value;

    compareLabel.textContent = `${countryA} vs ${countryB}`;
    dateLabel.textContent = "–";
    tracksBodyLeft.innerHTML = "<tr><td colspan='5'>Loading…</td></tr>";
    tracksBodyRight.innerHTML = "<tr><td colspan='5'>Loading…</td></tr>";

    titleLeft.textContent = `Top 20 – ${countryA}`;
    titleRight.textContent = `Top 20 – ${countryB}`;
    subtitleLeft.textContent = "Hoofdland";
    subtitleRight.textContent = "Vergelijkland";

    try {
      const [dataA, dataB] = await Promise.all([
        fetchTopTracks(countryA, 20),
        fetchTopTracks(countryB, 20)
      ]);

      // Toon datum van hoofdland (Apple geeft sowieso actuele feed)
      dateLabel.textContent = dataA.date || "";

      const tracksA = dataA.tracks || [];
      const tracksB = dataB.tracks || [];

      const mapA = new Map();
      const mapB = new Map();

      tracksA.forEach(t => mapA.set(buildKey(t), t));
      tracksB.forEach(t => mapB.set(buildKey(t), t));

      renderTable(tracksBodyLeft, tracksA, mapB, countryA, "left");
      renderTable(tracksBodyRight, tracksB, mapA, countryB, "right");
    } catch (err) {
      console.error(err);
      tracksBodyLeft.innerHTML =
        "<tr><td colspan='5'>Error loading data. Check console.</td></tr>";
      tracksBodyRight.innerHTML =
        "<tr><td colspan='5'>Error loading data. Check console.</td></tr>";
    }
  }

  primarySelect.addEventListener("change", loadCompare);
  secondarySelect.addEventListener("change", loadCompare);

  // Init
  populateCountrySelects();
  loadCompare();
</script>

</body>
</html>
